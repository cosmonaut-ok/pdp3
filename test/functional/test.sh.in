#!/bin/bash

set -e

test -z $TESTDIR && TESTDIR=testingdir
test -z $TRUE_MD5 && TRUE_MD5=test/functional/true_md5sums
test -z $TRUE_EXT_MD5 && TRUE_EXT_MD5=test/functional/true_ext_md5sums

## Set some colors
RED='\e[31m'
GREEN='\e[32m'
NC='\e[0m' # No Color

if [ -n "$1" ] && [ "$1" == "extended" ]; then
    PARAMETERS_XML=parameters_ext.xml.tmpl
    # END_TIME=1.05e-10
    TRUE_MD5=$TRUE_EXT_MD5
else
    PARAMETERS_XML=parameters.xml.tmpl
    # END_TIME=2.2e-11
fi

test -f ${TESTDIR} && rm -rf ${TESTDIR}
mkdir -p ${TESTDIR}
cp pdp3 ${TESTDIR}
cp -r tools ${TESTDIR}

cp $(dirname $0)/${PARAMETERS_XML} ${TESTDIR}/parameters.xml

cd ${TESTDIR}

time ./pdp3

if [ "@HDF5_OPTION@" == "true" ]; then
    ## dump data from hdf5 database
    echo -n "Dumping state data from database to plaintext for test..."
    for i in `h5ls -r pdp3_result/data.h5/pdp3/result | grep Dataset | awk '{print $1}'`; do
        h5dump -d /pdp3/result/$i -y -r -o pdp3_result/$(basename $(dirname $i))$(basename $i)_raw pdp3_result/data.h5 > /dev/null
    done
    echo "done"

    echo -n "Dumping data from database to plaintext for test..."
    for i in `h5ls -r pdp3_result/data.h5/pdp3/dump | grep Dataset | awk '{print $1}'`; do
        h5dump -d /pdp3/dump/$i -y -r -o pdp3_result/$(basename $i)_raw pdp3_result/data.h5 > /dev/null
    done
    echo "done"
fi

echo -n "Converting RAW data to format for md5sums comparation..."
cd pdp3_result
if [ "@HDF5_OPTION@" == "true" ]; then
    for i in `find . -name '*_raw' -type f`; do
        echo $(cat ${i} | tr ',' ' ') | tr ' ' '\n' > $(basename $i _raw)n
        rm -f ${i}
    done
else
    for i in `find .  -type f`; do
        echo $(cat ${i} | tr ',' ' ') | tr ' ' '\n' > ${i}n
        rm -f ${i}
    done
fi
echo "done"

## compare with testing data
success="true"
for i in `find . -name '*n' -type f`; do
    bn=`basename $i`
    true_md5sum="$(egrep ${i}$ ../../${TRUE_MD5} | cut -d';' -f1)"
    actual_md5sum="$(md5sum ${i} | cut -d' ' -f1)"
    if test "${true_md5sum}" == "${actual_md5sum}"; then
        printf "%-25b %-10b\n" "file $(dirname $i)/$(basename $bn n)" "${GREEN}match${NC}"
    else
        printf "%-25b %-10b\n" "file $(dirname $i)/$(basename $bn n)" "${RED}not match${NC}"
        success="false"
    fi
done

if [ "$success" == "false" ]; then
    echo
    echo "Test failed. Generated data is not match control data"
    exit 1
else
    echo
    echo "Test passed."
    echo
    exit 0
fi
